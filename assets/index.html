<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Customer and Trust Hub Profiles</title>
   
    <link
      rel="icon"
      href="https://twilio-labs.github.io/function-templates/static/v1/favicon.ico"
    />


    
   <link
      rel="stylesheet"
      href="twilioStyle.css"
    />

  <link rel="stylesheet" type="text/css" href="styles.css">
 
    <style>
      .success {
        border-color: #bce8f1;
        color: #31708f;
        background-color: #d9edf7;
      }
      .warning {
        color: #c21e1e;
        background-color: #f2dede;
        border-color: #ebccd1;
      }
    </style>
  </head>
  <body onload="mask()">
    <div class="page-top">
      <header>
      
        <div id="twilio-logo">
          <a href="https://www.twilio.com/" target="_blank" rel="noopener">
            <svg
              class="logo"
              data-name="Layer 1"
              xmlns="http://www.w3.org/2000/svg"
              viewbox="0 0 60 60"
            >
              <title>Twilio Logo</title>
              <path
                class="cls-1"
                d="M30,15A15,15,0,1,0,45,30,15,15,0,0,0,30,15Zm0,26A11,11,0,1,1,41,30,11,11,0,0,1,30,41Zm6.8-14.7a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,26.3Zm0,7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,36.8,33.7Zm-7.4,0a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,33.7Zm0-7.4a3.1,3.1,0,1,1-3.1-3.1A3.12,3.12,0,0,1,29.4,26.3Z"
              />
            </svg>
          </a>
        </div>
      
        <nav>
          <span>Your Twilio application</span>
          
          <aside>
            <svg
              class="icon"
              role="img"
              aria-hidden="true"
              width="100%"
              height="100%"
              viewBox="0 0 20 20"
              aria-labelledby="NewIcon-1577"
            >
              <path
                fill="currentColor"
                fill-rule="evenodd"
                d="M6.991 7.507c.003-.679 1.021-.675 1.019.004-.012 2.956 1.388 4.41 4.492 4.48.673.016.66 1.021-.013 1.019-2.898-.011-4.327 1.446-4.48 4.506-.033.658-1.01.639-1.018-.02-.03-3.027-1.382-4.49-4.481-4.486-.675 0-.682-1.009-.008-1.019 3.02-.042 4.478-1.452 4.49-4.484zm.505 2.757l-.115.242c-.459.9-1.166 1.558-2.115 1.976l.176.08c.973.465 1.664 1.211 2.083 2.22l.02.05.088-.192c.464-.973 1.173-1.685 2.123-2.124l.039-.018-.118-.05c-.963-.435-1.667-1.117-2.113-2.034l-.068-.15zm10.357-8.12c.174.17.194.434.058.625l-.058.068-1.954 1.905 1.954 1.908a.482.482 0 010 .694.512.512 0 01-.641.056l-.07-.056-1.954-1.908-1.954 1.908a.511.511 0 01-.71 0 .482.482 0 01-.058-.626l.058-.068 1.954-1.908-1.954-1.905a.482.482 0 010-.693.512.512 0 01.64-.057l.07.057 1.954 1.905 1.954-1.905a.511.511 0 01.71 0z"
              ></path>
            </svg>
            Live
          </aside>
         
        </nav>
         <nav>
    <aside>
      <div>
          <a href='https://console.twilio.com/us1/develop/functions/services'><h2>Customer and Trust Hub Profiles</h2></a>
          </div>
          </aside>
        </nav>
      </header>
    </div>
    <main>
      <div class="content">
        <h1>
          
          <img
            src="https://twilio-labs.github.io/function-templates/static/v1/success.svg"
          />
        
          <div>
            <p>Welcome!</p>
            <p>Your live application with Twilio is ready to use!</p>
          </div>
        </h1>
        <br />

<h3> Functionality of each Tool </h3>
<ul>

<h4>Phone Number(s) and their Linked Profiles</h4>
<ul>
<li><p>A bundle type must be selected from the options under the header  <span class="red-text">'Select Bundle Types to Check'. If no other filters are specified, this tool will display all numbers connected to Business + Trust Hub bundles under the parent account and its subaccounts.</span> </p></li>

<li><p>Other filter options are available under the 'Filter Options' checkbox. If selected, an account SID must be specified at the very least. Can add additional filter options if desired. </p></li>
</ul>
<h4>Assign Number(s) to Profile(s)</h4>
<ul>
<li><p>All requested information must be inputed in order to assign a number to a bundle. This tool can assign multiple numbers to multiple bundles at the same time. You must assign a number to a Business Profile before you can assign it to a Trust Hub Profile. Make sure the order of the inputs reflect this. </p></li>
</ul>
<h4>Remove Number(s) from Profile(s)</h4>
<ul>
<li><p>All requested information must be inputed in in order to remove a number from a bundle. Multiple numbers can be removed from multiple bundles at the same time.</p></li>
</ul>
<h4>Display all Profiles Under Account</h4>
<ul>
<li><p>Account SID input is optional. If Account SID is specified, it will only show profiles under the Account SID. If no Account SID is inputed, it will display all profiles under the parent account and its subaccounts.</p></li>
</ul>
</ul>
</br>
<h3> General Info</h3>
<ul>
</li>
<li><p> Make sure you choose how you want to recieve the data output(download/display).  </p></li>
<li><p>  <span class="red-text">'Phone Number(s) and their Linked Profiles'</span> AND  <span class="red-text">'Display all Profiles Under Account'</span> do not make any changes on your account. The tool 'reads' the profiles that are already on your account(s) and outputs the requested information. </p></li>
</li>
<li><p>
Because this is a publicly accessible URL that automatically uses your Account SID and auth_token, to limit it's access, please set a password in your Function - open the Function and click on "Environment Variables" in the bottom left corner, and change the value of Password. Click "Deploy All" afterwards in the bottom left corner.</p></li>
</ul>

<br/>
<h2> TrustHub and Customer Profile Toolbox </h2>
            <label for="auth_token"class="password-label">Password:</label>
                <div class="input-container">
 <!-- <textarea id="auth_token" name="auth_token" rows="2" cols="35" style="font-size: 17px; border-radius: 4px;resize: none;" placeholder="Enter your Twilio Auth Token."></textarea><br><br> -->
        <input id="auth_token" for="auth_token" name="auth_token" placeholder="Enter the password." type="password">
        </div>

    <form id="featureForm">
        <h4 class="darkbluetile"><input type="checkbox" class="feature-checkbox" name="feature" value="checkLinkedProducts" onclick="toggleTextBoxesAndColor('checkLinkedProducts', this)"> Phone Number(s) and their Linked Profiles</h4><br> 
        <!-- Textboxes for Check Linked Products -->
        <div id="checkLinkedProductsTextboxes" class="hidden" style="width: 80%;">
        <h4> <input id = "filterOptions" type="checkbox"  name="name" value="checkLinkedProducts" onclick="toggleTextBoxes('filter')"> Filter Options(not required)</h4><br> 
            <div id="filterTextboxes" class="hidden">
            <h5 class="redfilter-text">Phone Number(s)</h5>
            
            <textarea id="phoneNumberInput"  name="phoneNumbers" rows="4" cols="50" style="font-size: 15px;height: 200px; width: 400px;" placeholder="toggle checkbox to search all numbers under the parent account and it's subaccounts"></textarea><br><br>
            <h5 class="redfilter-text">BundleSID</h5>
            <input id = "BundleSidcheck" type="text" name="BundleSid">

            <h5 class="redfilter-text">Account SID(required)</h5>
            <input id = "AccountSidcheck" type="text" name="accountSids">
            </div>
            
                <h5>Select Bundle Types to Check</h5>
<input type="checkbox" name="regulationBundles" id="selectAll"> <label for="selectAll">Select All</label>


  <br>
 
<input type="checkbox" name="regulationBundles" value="RN6433641899984f951173ef1738c3bdd0"> Primary Business Profile<br>
<input type="checkbox" name="regulationBundles" value="RN7a97559effdf62d00f4298208492a5ea"> STIR / SHAKEN<br>
<input type="checkbox" name="regulationBundles" value="RNf3db3cd1fe25fcfd3c3ded065c8fea53"> CNAM<br>
<input type="checkbox" name="regulationBundles" value="RNdfbf3fae0e1107f8aded0e7cead80bf5"> Secondary Business Profile<br>
<input type="checkbox" name="regulationBundles" value="RNb0d4771c2c98518d916a3d4cd70a8f8b"> A2P<br>
<input type="checkbox" name="regulationBundles" value="RN806dd6cd175f314e1f96a9727ee271f4"> ISV Starter customer profile<br>
<input type="checkbox" name="regulationBundles" value="RN670d5d2e282a6130ae063b234b6019c8"> SoleProp (previously ISV Starter A2P)<br>
<input type="checkbox" name="regulationBundles" value="RN13dc4be8861a10924a79c35eaa4d812c"> Direct Starter customer profile (direct-long tail)<br>
<input type="checkbox" name="regulationBundles" value="RN63da8244384cf0401c39f5f91e674db5"> Starter A2P (direct customers)<br>
<input type="checkbox" name="regulationBundles" value="RN92dc6c39189b4d5ad9c6664f39769f90"> Government primary customer profile<br>
<input type="checkbox" name="regulationBundles" value="RN074d26323ad8ca107761a5edf4191ba7"> Government secondary customer profile<br>
<input type="checkbox" name="regulationBundles" value="RN936f6140f1864391adca88df5d84cb6d"> Nonprofit primary customer profile<br>
<input type="checkbox" name="regulationBundles" value="RNaf459d36b007ba6db226cd43a816cfa0"> Nonprofit secondary customer profile<br>
<input type="checkbox" name="regulationBundles" value="RNa282dd7f3dbef8586501ca2e045e764c"> Toll Free<br>
<input type="checkbox" name="regulationBundles" value="RN5b3660f9598883b1df4e77f77acefba0"> Voice Integrity<br>
<input type="checkbox" name="regulationBundles" value="RNca63d1066fbd5e44eac02d0b3cf6d019"> Branded Calling<br>
<input type="checkbox" name="regulationBundles" value="RNffcb02a20420c81caf596ffc44f69712"> Individual Primary customer profile<br>

<h5>Select How Results Will be Recieved</h5>
<input type="checkbox" id="LinkBundlesDownload" > Download Results<br>
<input type="checkbox" id="LinkBundlesDisplay" > Display Results<br>
<br>
<input type="button" value="Submit" onclick="performSelectedFeatures()">

                    </div>
        

        

        <!-- Bulk Assign Numbers -->
        <h4 class="purpletile"><input type="checkbox" name="feature" class="feature-checkbox" value="bulkAssign" onclick="toggleTextBoxesAndColor('bulkAssign', this)"> Assign Number(s) to Profile(s)</h4><br>
        <!-- Textboxes for Bulk Assign Numbers -->
        <div id="bulkAssignTextboxes" class="hidden" style="width: 80%;">
            <h5>Bundle SID(s)</h5>
            <textarea id="bundleSIDsInput"  name="bundleSIDs" rows="4" cols="50" style="font-size: 15px;height: 200px; width: 400px;" ></textarea><br><br>
            <h5>Phone Number(s)</h5>
             <textarea id="phoneNumbersAssign"  name="phoneNumbers" rows="4" cols="50" style="font-size: 15px;height: 200px; width: 400px;"></textarea><br><br>
             <h5>Account SID</h5>
            <input id = "AccountSidinput" type="text" name="accountSids">
            <h5>Select How Results Will be Recieved</h5>
            <input type="checkbox" id="AssignNumbersDownload" > Download Results<br>
            <input type="checkbox" id="AssignNumbersDisplay" > Display Results<br>
            <br>
            <input type="button" value="Submit" onclick="performSelectedFeatures()">
        </div>

        <!-- Remove Numbers from Trust Product or Business Profile -->
        <h4 class="greentile"><input type="checkbox" class="feature-checkbox" name="feature" value="removeNumbers" onclick="toggleTextBoxesAndColor('removeNumbers', this)"> Remove Number(s) from Profile(s)</h4><br>
        <!-- Textboxes for Remove Numbers -->
        <div id="removeNumbersTextboxes" class="hidden" style="width: 80%;">
            <h5>Bundle SID(s)</h5>
            <textarea id="bundleSIDsparam"  name="bundleSIDs" rows="4" cols="50" style="font-size: 15px;height: 200px; width: 400px;" ></textarea><br><br>
            <h5>Phone Number(s)</h5>
             <textarea id="phoneNumbersRemove"  name="phoneNumbers" rows="4" cols="50" style="font-size: 15px;height: 200px; width: 400px;"></textarea><br><br>
             <h5>Account SID</h5>
            <input id = "AccountSidparam" type="text" name="accountSids">
            <h5>Select How Results Will be Recieved</h5>
            <input type="checkbox" id="RemoveNumbersDownload" > Download Results<br>
            <input type="checkbox" id="RemoveNumbersDisplay" > Display Results<br>
            <br>
            <input type="button" value="Submit" onclick="performSelectedFeatures()">
        </div>


        <!-- Look Up Trust Products Under an Account SID -->
        <h4 class="orangetile"><input type="checkbox" name="feature" class="feature-checkbox" value="lookupTrustProducts" onclick="toggleTextBoxesAndColor('lookupTrustProducts', this)"> Display all Profiles Under Account</h4><br>
        <!-- Textboxes for Look Up Trust Products -->
        <div id="lookupTrustProductsTextboxes" class="hidden" style="width: 80%;">
            <h5>Account SID(Not Required)</h5>
            <input id = "AccountSid" type="text" name="accountSids"><br> 
            <h5>Select How Results Will be Recieved</h5>
            <input type="checkbox" id="BundlesDownload" > Download Results<br>
            <input type="checkbox" id="BundlesDisplay" > Display Results<br>
            <br>
            <input type="button" value="Submit" onclick="performSelectedFeatures()">
        </div>
        

        <!-- Include your JavaScript scripts here if needed -->

        <!-- Submit button to perform selected features -->
       

        <div id="responseContainer"></div>
        </div>  
    </form>
        <br />
        <div>
        <!-- EDIT_CODE -->
        </div>
      </div>
    </main>
    <footer>
      <span>We can't wait to see what you build.</span>
    </footer>


    <script>




    document.addEventListener("DOMContentLoaded", function() {
    const textareas = document.querySelectorAll("textarea[name='phoneNumbers']");
    
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function(e) {
            textarea.value = textarea.value.replace(/[^\d\n]/g, '');
        });
    });
});


    function toggleTextBoxes(feature) {
 
        var textboxes = document.getElementById(feature + "Textboxes");
  
        textboxes.classList.toggle("hidden", !textboxes.classList.contains("hidden"));
    }

function toggleTextBoxesAndColor(featureName, checkbox) {
    // Call your existing functionality to toggle text boxes

    toggleTextBoxes(featureName);

    // Define the original and the greyed out color
    const originalColor = ''; // Use '' if you want to revert to the stylesheet's color or set a specific color
    const greyedOutColor = 'grey';

    // Get all <h4> elements with the class 'feature-header'
var headers1 = document.querySelectorAll('.darkbluetile');
var headers2 = document.querySelectorAll('.purpletile');
var headers3 = document.querySelectorAll('.greentile');
var headers4 = document.querySelectorAll('.yellowtile');
var headers5 = document.querySelectorAll('.orangetile');

var allHeaders = [
    ...headers1,
    ...headers2,
    ...headers3,
    ...headers4,
    ...headers5
];

const isChecking = checkbox.checked;
const allCheckboxes = document.querySelectorAll('.feature-checkbox');
    allCheckboxes.forEach(function(chk) {
        // If the current checkbox in the loop is not the one clicked
        if (chk !== checkbox) {
            // Disable or enable the checkbox based on the state of the clicked checkbox
            chk.disabled = isChecking;
        }
    });
    // Loop through all <h4> elements
    allHeaders.forEach(function(header) {
        // Check if the current header contains the clicked checkbox
        if(header.contains(checkbox)) {
            // If the checkbox is checked
            if(checkbox.checked) {
                // Optional: Change the background color of the current <h4> to highlight it
                header.style.backgroundColor = originalColor; // You might want to set this to a highlight color instead of original
            } else {
                // If the checkbox is unchecked, revert to the original color
                header.style.backgroundColor = originalColor;
            }
        } else {
            // For other <h4> elements, set the background color based on the checkbox checked state
            header.style.backgroundColor = checkbox.checked ? greyedOutColor : originalColor;
        }
    });
}
    
    var selectAllCheckbox = document.getElementById('selectAll');
    var checkboxes = document.querySelectorAll('input[name="regulationBundles"]');


/* CSV functions for */

    
function convertDicToCSV(data,identifier){

  const headersSet = new Set();
  // Extracting keys and adding them to headersSet
  for (const key of Object.keys(data)) {
    const nestedKeys = Object.keys(data[key]);
    nestedKeys.forEach(nestedKey => headersSet.add(nestedKey));
  }
  const headers = [identifier, ...headersSet];

  // Constructing CSV string
  let csv = headers.join(',') + '\n';

  // Extracting values for each object
  for (const key of Object.keys(data)) {
    const values = headers.map(header => header === identifier ? key : data[key][header] || ''); // Handling missing values
    csv += values.join(',') + '\n';
  }

  return csv;
}




function downloadCSV(csvContent){
const blob = new Blob([csvContent], { type: 'text/csv' });
const csvurl = URL.createObjectURL(blob);

const a = document.createElement('a');
a.href = csvurl;
a.download = 'data.csv';
document.body.appendChild(a);
a.click();
return document.body.removeChild(a);

}


    // Add a click event listener to the "Select All" checkbox
    selectAllCheckbox.addEventListener('click', function () {
      // Loop through all checkboxes and set their checked property to the value of "Select All"
      checkboxes.forEach(function (checkbox) {
        checkbox.checked = selectAllCheckbox.checked;
      });
    });
  

        function performSelectedFeatures() {
            // Add your JavaScript logic here to handle the selected features

            var form = document.getElementById("featureForm");
           
            var selectedFeatures = Array.from(form.elements['feature'])
            .filter(checkbox => checkbox.checked && checkbox.name !== "filter")
            .map(checkbox => checkbox.value);
            
            var SelectedBundles = Array.from(form.elements['regulationBundles'])
                .filter(checkbox => checkbox.checked)
                .map(checkbox => checkbox.value);



            // Example: Log selected features to console
            if (selectedFeatures == 'lookupTrustProducts'){
                var accountSidInput = document.getElementById('AccountSid');

           // Accessing the value
            var accountSidValue = accountSidInput.value;
            var passwordInput = document.getElementById("auth_token");
            var password = passwordInput.value;

                getNumberInfo('lookupTrustProducts',accountSidValue,password)
            }
            
            if (selectedFeatures == 'checkLinkedProducts'){
            var passwordInput = document.getElementById("auth_token");
            var password = passwordInput.value;
            
            var filter = document.getElementById('filterOptions');    
            if(filter.checked){   
            var accountSidInput = document.getElementById('AccountSidcheck');
            var accountSidValue = accountSidInput.value;
            const bundleSIDInput = document.getElementById('BundleSidcheck');
            const bundleSIDValue = bundleSIDInput.value;
            const phoneNumberInput = document.getElementById('phoneNumberInput');
            const phoneNumberValue = phoneNumberInput.value;
            
           
                getLinkedProfiles(phoneNumberValue,SelectedBundles,'checkLinkedProducts',accountSidValue,bundleSIDValue,password,filter)
            }
            
            else{
                getLinkedProfiles('',SelectedBundles,'checkLinkedProducts','','',password,filter)
            }
            }

            if(selectedFeatures == 'bulkAssign'){
                
                assignNumber()
            }

            if(selectedFeatures == 'removeNumbers'){
                deleteNumber()
            }


  
        }
        //function to call delete function
        
// This is your new function. To start, set the name and path on the left.




async function deleteNumber() {


      responseContainer.innerHTML = 'LOADING';





            const downloadCheckbox = document.getElementById("RemoveNumbersDownload");
            const displayCheckbox = document.getElementById("RemoveNumbersDisplay");
            
            const phoneNumberAssignInput = document.getElementById('phoneNumbersRemove');
            const phoneNumberAssignValue = phoneNumberAssignInput.value;
       

                

            const bundleInput = document.getElementById('bundleSIDsparam');
            const bundleValue = bundleInput.value;

            const accountsidInput = document.getElementById('AccountSidparam');
            const accountValue = accountsidInput.value;
           
            var passwordInput = document.getElementById("auth_token");
            var password = passwordInput.value;
            const check =  await (pass_check(password))

            if(check.no_results){

      if(downloadCheckbox.checked){
      const csvContent = convertDicToCSV(check,"Phone Number")
      return downloadCSV(csvContent)
      }
      if(displayCheckbox.checked){
         return createTable(check,"Phone Number");
      }


            }

            var phoneNumberValue = phoneNumberAssignValue.split("\n");
            var bundlesArray = bundleValue.split("\n");
            


      const numbers = await get_pn_sids(phoneNumberValue, accountValue)
      const dataArray = await fetchAccountdata();
      const bundles = await processDataArray(dataArray, '', '')

    const clientArray = await fetchSingleAccountdata(accountValue)
   
    if (((clientArray[0] === null || clientArray[0].length ===0) && accountValue.length>0 ) || accountValue.length<1 ) {

      if(downloadCheckbox.checked){
      const csvContent = convertDicToCSV({ no_results: { message: 'Please enter a valid account sid' } },"Phone Number")
      return downloadCSV(csvContent)
      }
      if(displayCheckbox.checked){
         return createTable({ no_results: { message: 'Please enter a valid account sid' } },"Phone Number");
      }

    }

    
    var count = 0 
    responsedic = {}
    const promises = [];
    let bvSID;
    let raSID;


            for (var bundle of bundlesArray){
              const info =  retrieveInfo(bundles,bundle)

              if (info == 'customer'){
                   bvSID = await getBVsid(bundle,clientArray[0])
    
              }

              if (info == 'trust'){
                 raSID = await getRAsid(bundle,clientArray[0])
       
              }
             
              for (var number of numbers){

                count++;
                responseContainer.innerHTML = `LOADING ${count} assignments have been processed`;

             
                  /*
               if ('error' in obj) {
                    finalArray.push([obj.number, obj.error]);
                  }
                  */
                    if ('error' in number) {
                      if (!responsedic.hasOwnProperty(number.number)) {
                          responsedic[number.number] = {};
                        } 
                
                  responsedic[number.number][bundle] = number.error
                }
                else if (info == 'customer'){

                  promises.push(delete_number_customer(bundle, bvSID[number.sid], accountValue, number.number)     
                    .then(response => {
                      if (!responsedic.hasOwnProperty(response[0][0])) {
                        responsedic[response[0][0]] = {};
                      }
                      responsedic[response[0][0]][response[0][1]] = response[0][2];
                    })
                    .catch(error => console.error('Error removing number from customer:', error)));  
                    
                }

                else if (info == 'trust'){

                  
      
                  promises.push(delete_number_trust(bundle, raSID[number.sid], accountValue, number.number)
                    .then(response => {
                      if (!responsedic.hasOwnProperty(response[0][0])) {
                        responsedic[response[0][0]] = {};
                      }
                      responsedic[response[0][0]][response[0][1]] = response[0][2];
                    })
                    .catch(error => console.error('Error removing number from customer:', error)));           
                }
                else {
                if (!responsedic.hasOwnProperty(number[1])) {
                responsedic[number.number] = {};
              }
                responsedic[number.number][bundle] = info
              }
                if (count % 25 === 0){
                    await delay(1000);
                }

            }
            }

 await Promise.all(promises);
  

    if(downloadCheckbox.checked){
    const csvContent = convertDicToCSV(responsedic,"Phone Number")
    downloadCSV(csvContent)
    }
    if(displayCheckbox.checked){
        createTable(responsedic,"Phone Number");
    }
  }


async function assignNumber() {

  responseContainer.innerHTML = 'LOADING';

  const downloadCheckbox = document.getElementById("AssignNumbersDownload");
  const displayCheckbox = document.getElementById("AssignNumbersDisplay");

  const phoneNumberAssignInput = document.getElementById('phoneNumbersAssign');
  const phoneNumberAssignValue = phoneNumberAssignInput.value;




  const bundleInput = document.getElementById('bundleSIDsInput');
  const bundleValue = bundleInput.value;

  const accountsidInput = document.getElementById('AccountSidinput');
  const accountValue = accountsidInput.value;

  var passwordInput = document.getElementById("auth_token");
  var password = passwordInput.value;


  var phoneNumberValue = phoneNumberAssignValue.split("\n");
  var bundlesArray = bundleValue.split("\n");

              var passwordInput = document.getElementById("auth_token");
            var password = passwordInput.value;
            const check =  await (pass_check(password))

            if(check.no_results){

      if(downloadCheckbox.checked){
      const csvContent = convertDicToCSV(check,"Phone Number")
      return downloadCSV(csvContent)
      }
      if(displayCheckbox.checked){
         return createTable(check,"Phone Number");
      }


            }

  const numbers = await get_pn_sids(phoneNumberValue, accountValue)
  const dataArray = await fetchAccountdata();
  const bundles = await processDataArray(dataArray, '', '')


const clients = await fetchSingleAccountdata(accountValue)
if (((clients[0] === null || clients[0].length ===0) && accountValue.length>0 ) || accountValue.length<1 ) {
  
  if(downloadCheckbox.checked){
  const csvContent = convertDicToCSV({ no_results: { message: 'Please enter a valid account sid' } },"Phone Number")
  return downloadCSV(csvContent)
  }
  if(displayCheckbox.checked){
     return createTable({ no_results: { message: 'Please enter a valid account sid' } },"Phone Number");
  }

}

  var count = 0 
  var responsedic = {}
      


const promises = [];
  for (const bundle of bundlesArray) {
    const info = retrieveInfo(bundles, bundle);
    

    for (const number of numbers) {

      count++;
      responseContainer.innerHTML = `LOADING ${count} assignments have been processed`;

        if ('error' in number) {
          console.log("errrorhere")
          if (!responsedic.hasOwnProperty(number.number)) {
              responsedic[number.number] = {};
            } 
    
      responsedic[number.number][bundle] = number.error
    }
       else if (info === 'customer') {

        promises.push(assign_number_customer(bundle, number.sid, accountValue, number.number)
          .then(response => {
            if (!responsedic.hasOwnProperty(response[0][0])) {
              responsedic[response[0][0]] = {};
            }
            responsedic[response[0][0]][response[0][1]] = response[0][2];
          })
          .catch(error => console.error('Error assigning number to customer:', error)));
      } else if (info === 'trust') {

        promises.push(assign_number_trust(bundle, number.sid, accountValue, number.number)
          .then(response => {
            if (!responsedic.hasOwnProperty(response[0][0])) {
              responsedic[response[0][0]] = {};
            }
            responsedic[response[0][0]][response[0][1]] = response[0][2];
          })
          .catch(error => console.error('Error assigning number to trust:', error)));
      } else {
  
        if (!responsedic.hasOwnProperty(number.number)) {
          responsedic[number.number] = {};
        }
        responsedic[number.number][bundle] = info;
      }
      if (count % 25 === 0){
          await delay(1000);
      }
    }
  
}
  // Wait for all promises to resolve
  await Promise.all(promises);



  if(downloadCheckbox.checked){
  const csvContent = convertDicToCSV(responsedic,"Phone Number")
  downloadCSV(csvContent)
  }
  if(displayCheckbox.checked){
      createTable(responsedic,"Phone Number");
  }

  
}

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}


 async function getLinkedProfiles(phoneNumberValue, selectedBundles, selectedType,accountSidValue,bundleSID,password,filter) {

responseContainer.innerHTML = 'LOADING';
var phoneNumberValue = phoneNumberValue.split("\n");
const downloadCheckbox = document.getElementById("LinkBundlesDownload");
const displayCheckbox = document.getElementById("LinkBundlesDisplay");

var passwordInput = document.getElementById("auth_token");
var password = passwordInput.value;
const check =  await (pass_check(password))

if(check.no_results){

      if(downloadCheckbox.checked){
      const csvContent = convertDicToCSV(check,"Phone Number")
      return downloadCSV(csvContent)
      }
      if(displayCheckbox.checked){
         return createTable(check,"Phone Number");
      }


            }


      let responseData = await numbers_profiles(phoneNumberValue,selectedBundles,accountSidValue,bundleSID,filter);
      responseContainer.innerHTML = 'Working on Displaying/downloading results';
      if (Object.keys(responseData).length <1){
          responseData =  {no_results: {message: 'Please check if filters are correct'}};
      }

    if(downloadCheckbox.checked){
    const csvContent = convertDicToCSV(responseData,"PN SID")
    downloadCSV(csvContent)
    }
    if(displayCheckbox.checked){
    createTable(responseData,"PN SID");
    }
    
}

async function getNumberInfo(selectedType, accountSidValue, password) {

  responseContainer.innerHTML = 'LOADING';
  
    const downloadCheckbox = document.getElementById("BundlesDownload");
    const displayCheckbox = document.getElementById("BundlesDisplay");

    var passwordInput = document.getElementById("auth_token");
var password = passwordInput.value;
const check =  await (pass_check(password))

if(check.no_results){

      if(downloadCheckbox.checked){
      const csvContent = convertDicToCSV(check,"Phone Number")
      return downloadCSV(csvContent)
      }
      if(displayCheckbox.checked){
         return createTable(check,"Phone Number");
      }


            }

  const dataArray = await fetchAccountdata();
  let responseData = await processDataArray(dataArray, accountSidValue,'');

  // Send the successful response to Twilio
  
  if (Object.keys(responseData).length === 0) {
  
    responseData = {
      no_results: {
        message:
          "Please check if provided account sid is valid, or if your account has any Trust Hub/Business Profiles",
      },
    };
  }

  if (downloadCheckbox.checked) {
    const csvContent = convertDicToCSV(responseData, "Bundle SID");
    downloadCSV(csvContent);
  }
  if (displayCheckbox.checked) {
    createTable(responseData, "Bundle SID");
  }
}

async function get_trust_sid(sid,bundle) {
  const regulationSidMapping = {
    RN6433641899984f951173ef1738c3bdd0: "primary-business-profile",
    RN7a97559effdf62d00f4298208492a5ea: "STIR / SHAKEN",
    RNf3db3cd1fe25fcfd3c3ded065c8fea53: "CNAM",
    RNdfbf3fae0e1107f8aded0e7cead80bf5: "secondary-business-profile",
    RNb0d4771c2c98518d916a3d4cd70a8f8b: "A2P",
    RN806dd6cd175f314e1f96a9727ee271f4: "ISV Starter customer profile",
    RN670d5d2e282a6130ae063b234b6019c8: "SoleProp (previously ISV Starter A2P)",
    RN13dc4be8861a10924a79c35eaa4d812c:
      "Direct Starter customer profile (direct-long tail)",
    RN63da8244384cf0401c39f5f91e674db5: "Starter A2P (direct customers)",
    RN92dc6c39189b4d5ad9c6664f39769f90: "Government primary customer profile",
    RN074d26323ad8ca107761a5edf4191ba7: "Government secondary customer profile",
    RN936f6140f1864391adca88df5d84cb6d: "Nonprofit primary customer profile",
    RNaf459d36b007ba6db226cd43a816cfa0: "Nonprofit secondary customer profile",
    RNa282dd7f3dbef8586501ca2e045e764c: "Toll Free",
    RN5b3660f9598883b1df4e77f77acefba0: "Voice Integrity",
    RNca63d1066fbd5e44eac02d0b3cf6d019: "Branded Calling",
    RNffcb02a20420c81caf596ffc44f69712: "Individual Primary customer profile",
    // Add more mappings as needed
  };

  const temp_dic = {};
  let page_url = "0";
  while (page_url !== null) {
    const url = "/list_Trust_Bundles.js";

    const response = await fetch(url, {
      method: "POST", // Use 'GET' method to include parameters in headers
      headers: {
        "X-pageurl": page_url,
        "X-accountSid": sid,
        "x-bundlesidcheck": bundle,
        'x-type': "bundles"
      },
    });

    const data = await response.json();
   
    const trust_data = data[0];
 
    for (let i = 0; i < trust_data.length; i++) {
      if(trust_data[i].sid === bundle || bundle.length<1){
      {
        temp_dic[trust_data[i].sid] = {
          status: trust_data[i].status,
          friendlyName: trust_data[i].friendly_name.replace(/,/g, ":"),
          createdDate: trust_data[i].date_created,
          policySid: trust_data[i].policy_sid,
          accountSid: trust_data[i].account_sid,
          policyName: regulationSidMapping[trust_data[i].policy_sid],
          type: "trust",
        };
      }
    }
    }

    page_url = data[1];
  }
  return temp_dic;

  //
}

async function fetchAccountdata() {
  let page_url = "0";
  let responseData = [];
  while (page_url !== null) {
    const url = "/list_Accounts.js";

    const response = await fetch(url, {
      method: "POST", // Use 'GET' method to include parameters in headers
      headers: {
        "X-pageurl": page_url,
        // Add any other headers you may need
      },
    });

    const data = await response.json();

    // Extract account SID and auth token information into an array
    extractedData = data[0].map((account) => ({
      accountSid: account.sid,
    }));

    responseData = responseData.concat(extractedData);
    page_url = data[1];
  }

  return responseData;
}

async function pass_check(password){

  const url = "/single_functions.js";
  const response = await fetch(url, {
    method: "POST", // Use 'GET' method to include parameters in headers
    headers: {
      'x-password': password,
      'x-type':"password"
    },
  });

   const tempdata = await response.json();
   return tempdata
}

async function get_business_sid(sid,bundle) {

  const regulationSidMapping = {
    RN6433641899984f951173ef1738c3bdd0: "primary-business-profile",
    RN7a97559effdf62d00f4298208492a5ea: "STIR / SHAKEN",
    RNf3db3cd1fe25fcfd3c3ded065c8fea53: "CNAM",
    RNdfbf3fae0e1107f8aded0e7cead80bf5: "secondary-business-profile",
    RNb0d4771c2c98518d916a3d4cd70a8f8b: "A2P",
    RN806dd6cd175f314e1f96a9727ee271f4: "ISV Starter customer profile",
    RN670d5d2e282a6130ae063b234b6019c8: "SoleProp (previously ISV Starter A2P)",
    RN13dc4be8861a10924a79c35eaa4d812c:
      "Direct Starter customer profile (direct-long tail)",
    RN63da8244384cf0401c39f5f91e674db5: "Starter A2P (direct customers)",
    RN92dc6c39189b4d5ad9c6664f39769f90: "Government primary customer profile",
    RN074d26323ad8ca107761a5edf4191ba7: "Government secondary customer profile",
    RN936f6140f1864391adca88df5d84cb6d: "Nonprofit primary customer profile",
    RNaf459d36b007ba6db226cd43a816cfa0: "Nonprofit secondary customer profile",
    RNa282dd7f3dbef8586501ca2e045e764c: "Toll Free",
    RN5b3660f9598883b1df4e77f77acefba0: "Voice Integrity",
    RNca63d1066fbd5e44eac02d0b3cf6d019: "Branded Calling",
    RNffcb02a20420c81caf596ffc44f69712: "Individual Primary customer profile",
    // Add more mappings as needed
  };

  const temp_dic = {};
  let page_url = "0";
  while (page_url !== null) {
    const url = "/list_Customer_Bundles.js";

    const response = await fetch(url, {
      method: "POST", // Use 'GET' method to include parameters in headers
      headers: {
        "X-pageurl": page_url,
        "X-accountSid": sid,
        "x-bundlesidcheck": bundle,
        "x-type": "bundles"
      },
    });

    const data = await response.json();
    
    const trust_data = data[0];

    for (let i = 0; i < trust_data.length; i++) {
        if(trust_data[i].sid === bundle || bundle.length<1){
      {
        temp_dic[trust_data[i].sid] = {
          status: trust_data[i].status,
          friendlyName: trust_data[i].friendly_name.replace(/,/g, ":"),
          createdDate: trust_data[i].date_created,
          policySid: trust_data[i].policy_sid,
          accountSid: trust_data[i].account_sid,
          policyName: regulationSidMapping[trust_data[i].policy_sid],
          type: "business",
        };
      }
      }
      }

    page_url = data[1];
    }
  
  return temp_dic;

  //
}

async function processDataArray(dataArray, accountSID,bundle) {

  let combinedDict = {};
  const accountSIDCheck = accountSID.length;

  for (const item of dataArray) {

    if (item.accountSid === accountSID || accountSIDCheck < 1) {
      const businessSidData = await get_business_sid(item.accountSid,bundle);

      const trustSidData = await get_trust_sid(item.accountSid,bundle);
      combinedDict = { ...combinedDict, ...businessSidData, ...trustSidData };
    }
  }

  return combinedDict;
}

async function profiles_under_account(accountsidcheck,bundlesidcheck){

//getting auth/accound sid for all subaccounts
const dataArray = await fetchAccountdata()

//getting all bundles on subaccounts
const resultArray = await processDataArray(dataArray,accountsidcheck,bundlesidcheck)

return resultArray

};


  
async function numbers_profiles(numberList,bundleList,accountsidcheck,bundlesidcheck,filter){
  const sidArray = []
  const arraySids = []
  var customerCounter = 0;

  //make array
 // const numbersArray = numberList.split(',');

  const clients = await fetchSingleAccountdata(accountsidcheck)
if ((clients[0] === null || clients[0].length ===0) && filter.checked && accountsidcheck.length>0 ) {

  return { no_results: { message: 'Please enter a valid account sid' } };
}


if ((clients[0] === null || clients[0].length ===0) && filter.checked && (accountsidcheck.length ==0) && (bundlesidcheck.length>0 || numberList.length>0) ) {
  return { no_results: { message: 'Please enter an account sid' } };
}


  if(numberList.length >0 && (numberList[0]!=='')){
  const arraySids = await get_pn_sids(numberList,clients[0].sid)
 
  if (arraySids.length==0){
    return { no_results: { message: 'Please enter valid numbers for the given account sid' } }
  }

  arraySids.forEach(item => {
  const { sid, number } = item;
  sidArray.push(sid)

  });
  }



//returns bundles under account
const bundles = await profiles_under_account(accountsidcheck,bundlesidcheck);



const trustProfileSids = Object.entries(bundles)
    .filter(([key, profile]) => profile.type === "trust")
    .map(([key, profile]) => ({
        policySid: profile.policySid,
        sid: key, // Set sid to the key of bundles
        policyID: profile.policyName,
        accountSID: profile.accountSid
    }));


const CustomerProfile = Object.entries(bundles)
    .filter(([key, profile]) => profile.type === "business")
    .map(([key, profile]) => ({
        policySid: profile.policySid,
        sid: key, // Set sid to the key of bundles
        policyID: profile.policyName,
        accountSID: profile.accountSid
    }));




// Log the result
const resultDictionary = {};

for (let i = 0; i < CustomerProfile.length; i++) {
  // Assuming policyID is the property name in CustomerProfile

  if (bundleList.includes(CustomerProfile[i].policySid)) {
/*
    const client1 = require('twilio')(CustomerProfile[i].accountSID, CustomerProfile[i].token);
   const response = await client1.trusthub.v1.customerProfiles(CustomerProfile[i].sid)
    .customerProfilesChannelEndpointAssignment
    .page({ pageSize: 20 })

*/


const data = [];
let page_url = "0";
while (page_url !== null) {
  const url = "/list_Customer_Bundles.js";

  const response = await fetch(url, {
    method: "POST", // Use 'GET' method to include parameters in headers
    headers: {
      "X-pageurl": page_url,
      "X-accountSid": CustomerProfile[i].accountSID,
      'x-bundle': CustomerProfile[i].sid,
      'x-type': "assignments"
    },
  });

  const tempdata = await response.json();

  const customer_data = tempdata[0];
  for (let i = 0; i < customer_data.length; i++) {

      data.push(customer_data[i])
  }
  

  page_url = tempdata[1];
}



const test = {};
const promises = [];

for (let j = 0; j < data.length; j++) {
    const t = data[j];

    const pnSID = t.channel_endpoint_sid || t.channelEndpointSid;
    const customerSid = t.customerProfileSid || t.customer_profile_sid;
    if (!test[pnSID]) {
            customerCounter++;
            responseContainer.innerHTML = `LOADING ${customerCounter} numbers have been processed`;
            if (customerCounter % 25 === 0) {
            await delay(1000);
            }
        const promise = SidtoNumber(pnSID, CustomerProfile[i].accountSID)
            .then(phoneNumber => {
                test[pnSID] = { 'Phone Number': phoneNumber, accountSID: CustomerProfile[i].accountSID, [CustomerProfile[i].policyID]: customerSid};
            });
        promises.push(promise);
    } else {
        test[pnSID][CustomerProfile[j].policyID] = customerSid;
    }
}

await Promise.all(promises);



//const phoneNumber = await SidtoNumber(pnSID, CustomerProfile[i].accountSID);

    // Merge entries with the same pnSID
    Object.keys(test).forEach(pnSID => {
      if (!resultDictionary[pnSID]) {
        resultDictionary[pnSID] = test[pnSID];
      } else {
        Object.assign(resultDictionary[pnSID], test[pnSID]);
      }
    });
  }

}





for (let i = 0; i < trustProfileSids.length; i++) {
  // Assuming policyID is the property name in CustomerProfile

  if (bundleList.includes(trustProfileSids[i].policySid)) {
/*
    const client2 = require('twilio')(trustProfileSids[i].accountSID, trustProfileSids[i].token);n

   const response = await client2.trusthub.v1.trustProducts(trustProfileSids[i].sid)
    .trustProductsChannelEndpointAssignment
    .page({ pageSize: 20 })

*/
    const data = [];
    let page_url = "0";
    while (page_url !== null) {
      const url = "/list_Trust_Bundles.js";

      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-pageurl": page_url,
          "X-accountSid": trustProfileSids[i].accountSID,
          'x-bundle': trustProfileSids[i].sid,
          'x-type': "assignments"
        },
      });

      const tempdata = await response.json();
   
      const trust_data = tempdata[0];

      for (let i = 0; i < trust_data.length; i++) {
        
          data.push(trust_data[i])
        
      }


      page_url = tempdata[1];
    }
 

 /*
       const test = data.reduce((acc, t) => {
                const pnSID = t.channel_endpoint_sid || t.channelEndpointSid;
                const trustSid = t.trustProductSid ||t.trust_product_sid;
                if (!acc[pnSID]) {
                    acc[pnSID] = {accountSID: trustProfileSids[i].accountSID, [trustProfileSids[i].policyID]: trustSid};
                    
                } else {
                    acc[pnSID][trustProfileSids[i].policyID] = trustSid;
                }
                return acc;
            }, {});

*/

const test = {};
const promises = [];

for (let j = 0; j < data.length; j++) {
    const t = data[j];
    const pnSID = t.channel_endpoint_sid || t.channelEndpointSid;
    const trustSid = t.trustProductSid ||t.trust_product_sid;
    if (!test[pnSID]) {
            customerCounter++;
            responseContainer.innerHTML = `LOADING ${customerCounter} numbers have been processed`;
            if (customerCounter % 25 === 0) {
            await delay(1000);
            }
        const promise = SidtoNumber(pnSID, trustProfileSids[i].accountSID)
            .then(phoneNumber => {
                test[pnSID] = {'Phone Number': phoneNumber, accountSID: trustProfileSids[i].accountSID, [trustProfileSids[i].policyID]: trustSid};
            });
        promises.push(promise);
    } else {
        test[pnSID][trustProfileSids[j].policyID] = trustSid;
    }
}

await Promise.all(promises);



  Object.keys(test).forEach(pnSID => {
    if (!resultDictionary[pnSID]) {
      resultDictionary[pnSID] = test[pnSID];
    } else {
      Object.assign(resultDictionary[pnSID], test[pnSID]);
    }
  });
  }

}

if (sidArray.length >0) {
Object.keys(resultDictionary).forEach(key => {
  if (!sidArray.includes(key)) {
    delete resultDictionary[key];
  }
});


arraySids.forEach(item => {
  const { sid, number } = item;

  // Check if the sid entry exists in the dictionary
  if (resultDictionary.hasOwnProperty(sid)) {
    // Add or update the number property in the dictionary
    resultDictionary[sid].number = number;
  } 
});
}

  let count = 0;
  const promises = [];


return resultDictionary

}

async function SidtoNumber(number, accountSID) {

  try {

    const url = "/single_functions.js";

    const response = await fetch(url, {
      method: "POST", // Use 'GET' method to include parameters in headers
      headers: {
        "X-accountSid": accountSID,
        'x-type': "sidtonumber",
        'x-number': number
      },
    });
  const data = await response.json()

  return data.phoneNumber

  } catch (error) {
    // Handle the error here
    console.error("An error occurred while fetching incoming phone number:", error);
    // You can choose to return an error message or throw the error further if needed
    throw error;
  }
}


  async function fetchSingleAccountdata(accountSID) {

  try {

      
      const url = "/single_functions.js";

      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-accountSid": accountSID,
          'x-type': "account"
          
        },
      });

      const data = await response.json();

    return [data];

    // Extract account SID and auth token information into an array



    // Log the result


    // Use data or pass it to another function
  } catch (error) {
   return[null]

  }
}
//pass did through function :) 
async function assign_number_customer(bundle_sid,phone_number,account_sid,did){
  const url = '/single_functions.js'
  const response = await fetch(url, {
    method: "POST", // Use 'GET' method to include parameters in headers
    headers: {
      "X-accountSid": account_sid,
      'x-type': "businessassign",
      'x-did': did,
      'x-bundle': bundle_sid,
      'x-number': phone_number
    },
  });

  const data = await response.json();
  return data
}

//have to convert phone numbers to sid
async function assign_number_trust(bundle_sid,phone_number,account_sid,did) {
  const url = '/single_functions.js'
  const response = await fetch(url, {
    method: "POST", // Use 'GET' method to include parameters in headers
    headers: {
      "X-accountSid": account_sid,
      'x-type': "trustassign",
      'x-did': did,
      'x-bundle': bundle_sid,
      'x-number': phone_number
    },
  });

  const data = await response.json();
  return data
}



        function retrieveInfo(bundlesOnAccount,bundle){

          try {
              const bundledic = bundlesOnAccount[bundle];

              if (bundledic.type === "business") {
                  return 'customer';
              }

              if (bundledic.type === "trust") {
                  return 'trust';
              }
              else{
                return 'Bundle found but no type connected to it'
              }
          } catch (error) {
              // Handle the error here
              return 'Not a Valid Bundle on this account'
              // Optionally, return a default value or rethrow the error
          }



        }
async function get_pn_sids(numbers, sid) {

  const promises = [];

  for (const number of numbers) {
    const promise = (async () => {
      try {
        const url = "/single_functions.js";

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-accountSid": sid,
            'x-type': "pn_sids",
            'x-number': number
          },
        });

        const incomingPhoneNumbers = await response.json();

        return incomingPhoneNumbers

      } catch (error) {
        console.error(`Error fetching incoming phone numbers for ${number}:`, error);
        return { error: `error fetching incoming phone numbers for ${number}`, number: number };
      }
    })();

    promises.push(promise);
  }

  // Wait for all promises to resolve
  const results = await Promise.all(promises);

  return results;
}



 async function getRAsid(bundle,aSID) {
    const data = {};
    let page_url = "0";
    while (page_url !== null) {
      const url = "/list_Trust_Bundles.js";

      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-pageurl": page_url,
          "X-accountSid": aSID.sid,
          'x-bundle': bundle,
          'x-type': "assignments"
        },
      });

      const tempdata = await response.json();

      const trust_data = tempdata[0];
        trust_data.forEach(t => {
          data[t.channelEndpointSid || t.channel_endpoint_sid] = t.sid;
      });


      page_url = tempdata[1];
    }
    return data
  }

  async function getBVsid(bundle,aSID) {
    const data = {};
    let page_url = "0";
    while (page_url !== null) {
      const url = "/list_Customer_Bundles.js";

      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-pageurl": page_url,
          "X-accountSid": aSID.sid,
          'x-bundle': bundle,
          'x-type': "assignments"
        },
      });

      const tempdata = await response.json();

      const customer_data = tempdata[0];
        customer_data.forEach(t => {
          data[t.channelEndpointSid || t.channel_endpoint_sid] = t.sid;
      });


      page_url = tempdata[1];
    }
    return data

  }



      //have to convert phone numbers to sid
    async function delete_number_customer(bundle_sid,phone_number,account_sid,did){
      const url = '/single_functions.js'
      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-accountSid": account_sid,
          'x-type': "businessdelete",
          'x-did': did,
          'x-bundle': bundle_sid,
          'x-number': phone_number
        },
      });

      const data = await response.json();
      return data
    }

    //have to convert phone numbers to sid
    async function delete_number_trust(bundle_sid,phone_number,account_sid,did) {
      const url = '/single_functions.js'
      const response = await fetch(url, {
        method: "POST", // Use 'GET' method to include parameters in headers
        headers: {
          "X-accountSid": account_sid,
          'x-type': "trustdelete",
          'x-did': did,
          'x-bundle': bundle_sid,
          'x-number': phone_number
        },
      });

      const data = await response.json();
      return data
    }
    
 

function createTable(data, identifier) {
    const responseContainer = document.getElementById("responseContainer");
    const table = document.createElement("table");
    table.style.borderCollapse = "collapse";
    table.style.width = "100%";

    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    // Extract column headers from the objects
    const columns = new Set();
    Object.values(data).forEach(obj => {
        Object.keys(obj).forEach(key => {
            columns.add(key);
        });
    });

    // Add the identifier column as the first column
    const columnHeaders = [identifier, ...columns];

    // Create table header
    const headerRow = document.createElement("tr");
    columnHeaders.forEach(column => {
        const th = document.createElement("th");
        th.textContent = column;
        th.style.border = "1px solid #dddddd";
        th.style.textAlign = "left";
        th.style.padding = "8px";
        th.style.backgroundColor = "#f2f2f2";
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Create table body
    Object.entries(data).forEach(([id, obj]) => {
        const row = document.createElement("tr");

        // Add identifier to the first cell
        const identifierCell = document.createElement("td");
        identifierCell.textContent = id;
        identifierCell.style.border = "1px solid #dddddd";
        identifierCell.style.textAlign = "left";
        identifierCell.style.padding = "8px";
        row.appendChild(identifierCell);

        // Add object properties to subsequent cells
        columnHeaders.slice(1).forEach(column => {
            const td = document.createElement("td");
            td.textContent = obj[column] || ''; // Handle undefined values
            td.style.border = "1px solid #dddddd";
            td.style.textAlign = "left";
            td.style.padding = "8px";
            row.appendChild(td);
        });

        tbody.appendChild(row);
    });

    table.appendChild(tbody);
    responseContainer.innerHTML = '';
    responseContainer.appendChild(table);
}






    </script>
  </body>
</html> 
